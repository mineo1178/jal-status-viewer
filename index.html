<!-- gv4.30 - GitHub Raw Auto Sync + Debug JSON (Single-file Complete) -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JAL Status Viewer gv4.30</title>

  <!-- Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root { --jal-red:#E10009; }
    body { background:#f1f5f9; }
    .sidebar { width: 260px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .9rem; border-radius:.75rem; font-weight:800; font-size:.85rem; }
    .btn-red { background:var(--jal-red); color:#fff; }
    .btn-red:hover { filter:brightness(.95); }
    .btn-slate { background:#0f172a; color:#fff; }
    .btn-slate:hover { filter:brightness(1.08); }
    .btn-outline { border:1px solid #cbd5e1; background:#fff; color:#0f172a; }
    .btn-outline:hover { background:#f8fafc; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .badge { font-size:.75rem; font-weight:900; padding:.2rem .55rem; border-radius:999px; }
    .badge-ok { background:#dcfce7; color:#166534; }
    .badge-ng { background:#fee2e2; color:#991b1b; }
    .badge-warn { background:#ffedd5; color:#9a3412; }
  </style>
</head>

<body class="h-screen overflow-hidden">
  <!-- Top Bar -->
  <header class="h-14 bg-slate-900 text-white flex items-center justify-between px-4">
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-plane text-[var(--jal-red)]"></i>
      <div class="font-black tracking-tight">JAL Status Viewer <span class="ml-2 text-slate-300 font-extrabold">gv4.30</span></div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnSync" class="btn btn-red">
        <i class="fa-solid fa-rotate"></i> 自動URLから同期
      </button>

      <label class="btn btn-outline cursor-pointer">
        <i class="fa-solid fa-file-excel text-emerald-600"></i> ローカルExcel
        <input id="fileInput" type="file" class="hidden" accept=".xlsx,.xls,.csv"/>
      </label>
    </div>
  </header>

  <div class="flex h-[calc(100vh-56px)]">
    <!-- Sidebar -->
    <aside class="sidebar bg-white border-r border-slate-200 p-4 overflow-y-auto">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div class="font-black text-slate-800">自動読み込みURL</div>
          <span id="urlBadge" class="badge badge-warn">未同期</span>
        </div>
        <p class="text-xs text-slate-500 mt-2">
          このURLのExcelを fetch して解析します（GitHub Raw 推奨）。
        </p>
        <textarea id="urlInput" class="w-full mt-3 p-3 text-xs rounded-xl border border-slate-200 mono" rows="4"></textarea>
        <div class="flex gap-2 mt-3">
          <button id="btnCopyUrl" class="btn btn-outline text-xs">
            <i class="fa-regular fa-copy"></i> URLコピー
          </button>
          <button id="btnTestUrl" class="btn btn-slate text-xs">
            <i class="fa-solid fa-bug"></i> 接続テスト
          </button>
        </div>
      </div>

      <div class="card p-4 mt-4">
        <div class="font-black text-slate-800 mb-2">直近読み込み状況</div>
        <div id="statusBox" class="text-xs text-slate-700 space-y-1"></div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6 overflow-y-auto">
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4">
          <div class="text-[10px] font-black text-slate-400 tracking-widest">MILES</div>
          <div id="statMiles" class="text-3xl font-black text-slate-800 mt-2">0</div>
        </div>
        <div class="card p-4">
          <div class="text-[10px] font-black text-slate-400 tracking-widest">LSP</div>
          <div id="statLsp" class="text-3xl font-black text-slate-800 mt-2">0</div>
        </div>
        <div class="card p-4">
          <div class="text-[10px] font-black text-slate-400 tracking-widest">FOP (THIS YEAR)</div>
          <div id="statFop" class="text-3xl font-black text-slate-800 mt-2">0</div>
        </div>
        <div class="card p-4">
          <div class="text-[10px] font-black text-slate-400 tracking-widest">FLIGHTS (THIS YEAR)</div>
          <div id="statFlights" class="text-3xl font-black text-slate-800 mt-2">0</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="card p-4">
          <div class="font-black text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-[var(--jal-red)]"></i> マイル内訳（簡易）
          </div>
          <div class="h-64 mt-3"><canvas id="milePie"></canvas></div>
        </div>
        <div class="card p-4">
          <div class="font-black text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-blue-600"></i> LSP内訳（簡易）
          </div>
          <div class="h-64 mt-3"><canvas id="lspPie"></canvas></div>
        </div>
      </div>

      <!-- Debug JSON -->
      <div class="card p-4 mt-4">
        <div class="flex items-center justify-between">
          <div class="font-black text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-code text-slate-700"></i> Debug JSON
          </div>
          <div class="flex gap-2">
            <button id="btnCopyDebug" class="btn btn-outline text-xs">
              <i class="fa-regular fa-copy"></i> Debugコピー
            </button>
            <button id="btnClearDebug" class="btn btn-outline text-xs">
              <i class="fa-regular fa-trash-can"></i> クリア
            </button>
          </div>
        </div>
        <pre id="debugJson" class="mono text-xs mt-3 p-3 bg-slate-50 border border-slate-200 rounded-xl min-h-[160px]"></pre>
        <p class="text-xs text-slate-500 mt-2">
          ここが空のままなら、読み込み処理が走っていない or 途中で例外停止しています。必ず理由が出る設計です。
        </p>
      </div>
    </main>
  </div>

<script>
/**
 * gv4.30
 * - GitHub Raw URLのExcelを自動取得
 * - 失敗しても必ず Debug JSON と status に出す
 * - ローカルExcelも引き続き読める
 */

// ✅ 推奨：raw.githubusercontent.com 形式（安定）
const DEFAULT_AUTO_URL =
  "https://raw.githubusercontent.com/mineo1178/jal-status-viewer/main/data/20251229_LSP%E7%AE%A1%E7%90%86.xlsx";

let charts = { milePie: null, lspPie: null };

const appData = {
  miles: [], // {date, content, gain, total, fop, flight_count, ui_category}
  lsp: [],   // {date, category, service, content, points, total, ui_category}
  plans: [], // {date, from, to, flightNo, depTime, arrTime, status, airline}
  stats: { miles:0, lsp:0, fop:0, flights:0 }
};

const el = (id) => document.getElementById(id);

function nowTime() {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  const ss = String(d.getSeconds()).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}

function pushStatus(msg, kind="info") {
  const box = el("statusBox");
  const color = kind==="ok" ? "text-emerald-700" : kind==="ng" ? "text-red-700" : "text-slate-700";
  const line = document.createElement("div");
  line.className = `flex gap-2 ${color}`;
  line.innerHTML = `<span class="font-black w-[54px]">${nowTime()}</span><span class="flex-1">${escapeHtml(msg)}</span>`;
  box.prepend(line);
}

function setBadge(state) {
  const b = el("urlBadge");
  b.classList.remove("badge-ok","badge-ng","badge-warn");
  if (state==="ok") { b.classList.add("badge-ok"); b.textContent="同期OK"; }
  else if (state==="ng") { b.classList.add("badge-ng"); b.textContent="同期NG"; }
  else { b.classList.add("badge-warn"); b.textContent="未同期"; }
}

function setDebug(obj) {
  el("debugJson").textContent = JSON.stringify(obj, null, 2);
}

function clearDebug() {
  el("debugJson").textContent = "";
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

function parseDate(val) {
  if (!val) return "";
  // Date object
  if (val instanceof Date) {
    return val.toISOString().split("T")[0];
  }
  // Excel serial
  if (typeof val === "number") {
    const d = new Date((val - 25569) * 86400 * 1000);
    return isNaN(d.getTime()) ? "" : d.toISOString().split("T")[0];
  }
  // String
  const s = String(val).trim();
  if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)) return s;
  if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)) return s.replaceAll("/","-");
  return s;
}

// ===== Sheet detection & parsing =====
function findHeaderRow(rows, keywords) {
  return rows.findIndex(r =>
    Array.isArray(r) && r.some(c =>
      typeof c === "string" && keywords.some(k => c.includes(k))
    )
  );
}

function safeIndexOf(headerRow, colName) {
  if (!headerRow) return -1;
  return headerRow.findIndex(c => String(c||"").trim() === colName);
}

function categorizeMile(content) {
  const c = String(content || "");
  if (c.match(/[A-Z]{2,3}\d+/) || ["羽田","那覇","福岡","石垣","宮古","成田","伊丹","HND","FUK","OKA"].some(k => c.includes(k))) return "フライト獲得";
  if (c.includes("カード") || c.includes("ClubQ") || c.includes("JALカード")) return "JALカード決済";
  if (c.toLowerCase().includes("wellness")) return "Wellness";
  return "その他獲得";
}

function categorizeLSP(category, service) {
  const cat = String(category||"");
  const serv = String(service||"");
  if (cat.includes("航空")) return serv.includes("国内") ? "航空: 国内線" : "航空: その他";
  if (cat.includes("ライフ")) return "ライフスタイル";
  return "その他獲得";
}

function resetDataKeepStats() {
  appData.miles = [];
  appData.lsp = [];
  appData.plans = [];
  appData.stats = { miles:0, lsp:0, fop:0, flights:0 };
}

function parseWorkbook(wb, rawRowsBySheet) {
  resetDataKeepStats();

  // Parse each sheet with flexible header detection
  wb.SheetNames.forEach(sheetName => {
    const rows = rawRowsBySheet[sheetName] || [];
    if (!rows || rows.length === 0) return;

    // LSP
    let idx = findHeaderRow(rows, ["積算日"]);
    if (idx !== -1) {
      const h = rows[idx];
      const iDate = safeIndexOf(h, "積算日");
      const iCat  = safeIndexOf(h, "カテゴリー");
      const iServ = safeIndexOf(h, "サービス");
      const iCont = safeIndexOf(h, "内容");
      const iPts  = safeIndexOf(h, "ポイント");
      const iTot  = safeIndexOf(h, "累積ポイント");

      const body = rows.slice(idx+1).filter(r => r && r[iDate]);
      appData.lsp = body.map((r, k) => {
        const date = parseDate(r[iDate]);
        const category = r[iCat] ?? "不明";
        const service  = r[iServ] ?? "不明";
        const content  = r[iCont] ?? "";
        const points   = Number(r[iPts]) || 0;
        const total    = Number(r[iTot]) || 0;
        return {
          _idx:k, date, category, service, content, points, total,
          ui_category: categorizeLSP(category, service)
        };
      }).filter(x => /^\d{4}/.test(x.date));
      return;
    }

    // Miles
    idx = findHeaderRow(rows, ["有効マイル"]);
    if (idx !== -1) {
      const h = rows[idx];

      // よくある配置（あなたの旧版に合わせる）
      // A:日付 B:内容 ... H:獲得 I:有効(合計) J:FOP K:搭乗回数
      const body = rows.slice(idx+1).filter(r => r && r[0]);
      appData.miles = body.map((r, k) => {
        const date = parseDate(r[0]);
        const content = r[1] ?? "";
        const gain = parseInt(r[7]) || 0;
        const total = parseInt(r[8]) || 0;
        const fop = parseInt(r[9]) || 0;
        const flight_count = parseInt(r[10]) || 0;
        return {
          _idx:k, date, content, gain, total, fop, flight_count,
          ui_category: categorizeMile(content)
        };
      }).filter(x => /^\d{4}/.test(x.date));
      return;
    }

    // Plans
    idx = findHeaderRow(rows, ["出発地"]);
    if (idx !== -1) {
      const h = rows[idx];
      const iDate = safeIndexOf(h, "日付");
      const iAir  = safeIndexOf(h, "運航会社");
      const iNo   = safeIndexOf(h, "便名");
      const iFrom = safeIndexOf(h, "出発地");
      const iTo   = safeIndexOf(h, "到着地");
      const iDep  = safeIndexOf(h, "出発時刻");
      const iArr  = safeIndexOf(h, "到着時刻");
      const iSt   = safeIndexOf(h, "結果");

      const body = rows.slice(idx+1).filter(r => r && r[iDate]);
      appData.plans = body.map((r) => ({
        date: parseDate(r[iDate]),
        airline: r[iAir] ?? "",
        flightNo: r[iNo] ?? "",
        from: r[iFrom] ?? "",
        to: r[iTo] ?? "",
        depTime: r[iDep] ?? "",
        arrTime: r[iArr] ?? "",
        status: r[iSt] ?? "予定"
      })).filter(x => /^\d{4}/.test(x.date));
      return;
    }
  });

  // Stats compute
  const year = String(new Date().getFullYear());

  if (appData.miles.length > 0) {
    const latest = [...appData.miles].sort((a,b)=> b.date.localeCompare(a.date) || (b._idx-a._idx))[0];
    appData.stats.miles = latest.total || 0;

    const ym = appData.miles.filter(m => String(m.date).startsWith(year));
    appData.stats.fop = ym.reduce((s,m)=> s + (m.fop||0), 0);
    appData.stats.flights = ym.reduce((s,m)=> s + (m.flight_count||0), 0);
  }

  if (appData.lsp.length > 0) {
    const latest = [...appData.lsp].sort((a,b)=> b.date.localeCompare(a.date) || (b._idx-a._idx))[0];
    appData.stats.lsp = latest.total || 0;
  }
}

function updateUI() {
  el("statMiles").textContent   = (appData.stats.miles||0).toLocaleString();
  el("statLsp").textContent     = (appData.stats.lsp||0).toLocaleString();
  el("statFop").textContent     = (appData.stats.fop||0).toLocaleString();
  el("statFlights").textContent = (appData.stats.flights||0).toLocaleString();

  renderPie("milePie", groupSum(appData.miles, "ui_category", (x)=> Math.max(0, x.gain||0)));
  renderPie("lspPie", groupSum(appData.lsp, "ui_category", (x)=> x.points||0));
}

function groupSum(arr, key, valueFn) {
  const g = {};
  for (const item of arr) {
    const k = String(item[key] ?? "不明");
    g[k] = (g[k] || 0) + (valueFn(item) || 0);
  }
  return g;
}

function renderPie(canvasId, groups) {
  const ctx = el(canvasId).getContext("2d");
  const labels = Object.keys(groups).sort((a,b)=> groups[b]-groups[a]);
  const data = labels.map(l => groups[l]);

  if (charts[canvasId]) charts[canvasId].destroy();

  charts[canvasId] = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{ data }]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins: {
        legend: { position:"bottom" }
      }
    }
  });
}

// ===== Fetch & Debug =====
async function testUrlOnly() {
  const url = el("urlInput").value.trim();
  clearDebug();
  pushStatus("接続テスト開始: " + url);
  setBadge("warn");

  const debug = { phase:"test", url };
  try {
    const res = await fetch(url, { method:"GET" });
    debug.http = { ok: res.ok, status: res.status, statusText: res.statusText, contentType: res.headers.get("content-type") };
    setDebug(debug);
    if (!res.ok) {
      setBadge("ng");
      pushStatus(`接続NG (HTTP ${res.status})`, "ng");
      return;
    }
    setBadge("ok");
    pushStatus(`接続OK (HTTP ${res.status})`, "ok");
  } catch (e) {
    debug.error = { name:e?.name, message:e?.message, stack:String(e?.stack||"") };
    setDebug(debug);
    setBadge("ng");
    pushStatus(`接続NG (例外) ${e?.message}`, "ng");
  }
}

async function syncFromUrl(auto = false) {
  const url = el("urlInput").value.trim();
  clearDebug();
  setBadge("warn");

  pushStatus((auto ? "自動同期開始: " : "同期開始: ") + url);

  const debug = {
    phase:"sync",
    url,
    fetch: {},
    workbook: {},
    parse: {},
    stats: {}
  };

  try {
    const res = await fetch(url, { method:"GET" });
    debug.fetch.ok = res.ok;
    debug.fetch.status = res.status;
    debug.fetch.statusText = res.statusText;
    debug.fetch.contentType = res.headers.get("content-type");

    if (!res.ok) {
      setBadge("ng");
      pushStatus(`同期NG (HTTP ${res.status})`, "ng");
      setDebug(debug);
      return;
    }

    const buf = await res.arrayBuffer();
    debug.fetch.bytes = buf.byteLength;

    const wb = XLSX.read(buf, { type:"array", cellDates:true });
    debug.workbook.sheetNames = wb.SheetNames;

    // Convert rows for each sheet for parsing + debug sample
    const rawRowsBySheet = {};
    const sheetInfo = {};
    wb.SheetNames.forEach(name => {
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { header:1, raw:true });
      rawRowsBySheet[name] = rows;
      sheetInfo[name] = { rows: rows.length, cols: Array.isArray(rows[0]) ? rows[0].length : 0 };
    });

    debug.workbook.sheetInfo = sheetInfo;

    // Parse
    parseWorkbook(wb, rawRowsBySheet);

    debug.parse.counts = {
      miles: appData.miles.length,
      lsp: appData.lsp.length,
      plans: appData.plans.length
    };

    // Samples (先頭数行)
    const sample = {};
    for (const name of wb.SheetNames) {
      const rows = rawRowsBySheet[name] || [];
      sample[name] = rows.slice(0, 6); // header + 5 rows
    }
    debug.workbook.sampleRows = sample;

    debug.stats = { ...appData.stats };

    // Update UI
    updateUI();

    setBadge("ok");
    pushStatus(`同期OK: miles=${appData.miles.length}, lsp=${appData.lsp.length}, plans=${appData.plans.length}`, "ok");

    setDebug(debug);
  } catch (e) {
    debug.error = { name:e?.name, message:e?.message, stack:String(e?.stack||"") };
    setDebug(debug);
    setBadge("ng");
    pushStatus(`同期NG (例外) ${e?.message}`, "ng");
  }
}

// ===== Local file loader =====
function loadFromLocalFile(file) {
  clearDebug();
  setBadge("warn");
  pushStatus("ローカル読み込み開始: " + (file?.name||""));
  const debug = { phase:"local", file: { name:file?.name, size:file?.size, type:file?.type }, workbook:{}, parse:{}, stats:{} };

  const reader = new FileReader();
  reader.onerror = () => {
    debug.error = { name:"FileReaderError", message:"FileReader failed" };
    setDebug(debug);
    setBadge("ng");
    pushStatus("ローカル読み込みNG: FileReader失敗", "ng");
  };
  reader.onload = (ev) => {
    try {
      const buf = ev.target.result;
      const wb = XLSX.read(buf, { type:"array", cellDates:true });
      debug.workbook.sheetNames = wb.SheetNames;

      const rawRowsBySheet = {};
      const sheetInfo = {};
      wb.SheetNames.forEach(name => {
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { header:1, raw:true });
        rawRowsBySheet[name] = rows;
        sheetInfo[name] = { rows: rows.length, cols: Array.isArray(rows[0]) ? rows[0].length : 0 };
      });
      debug.workbook.sheetInfo = sheetInfo;

      parseWorkbook(wb, rawRowsBySheet);
      updateUI();

      debug.parse.counts = { miles: appData.miles.length, lsp: appData.lsp.length, plans: appData.plans.length };
      debug.stats = { ...appData.stats };

      setBadge("ok");
      pushStatus(`ローカルOK: miles=${appData.miles.length}, lsp=${appData.lsp.length}, plans=${appData.plans.length}`, "ok");
      setDebug(debug);
    } catch (e) {
      debug.error = { name:e?.name, message:e?.message, stack:String(e?.stack||"") };
      setDebug(debug);
      setBadge("ng");
      pushStatus(`ローカルNG (例外) ${e?.message}`, "ng");
    }
  };
  reader.readAsArrayBuffer(file);
}

// ===== UI wiring =====
window.addEventListener("load", () => {
  el("urlInput").value = DEFAULT_AUTO_URL;

  el("btnSync").addEventListener("click", () => syncFromUrl(false));
  el("btnTestUrl").addEventListener("click", () => testUrlOnly());

  el("btnCopyUrl").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(el("urlInput").value.trim());
      pushStatus("URLをコピーしました", "ok");
    } catch {
      pushStatus("URLコピーに失敗（ブラウザ権限）", "ng");
    }
  });

  el("btnCopyDebug").addEventListener("click", async () => {
    const t = el("debugJson").textContent || "";
    if (!t) { pushStatus("Debugが空です（まだ同期していない）", "ng"); return; }
    try {
      await navigator.clipboard.writeText(t);
      pushStatus("Debug JSON をコピーしました", "ok");
    } catch {
      pushStatus("Debugコピーに失敗（ブラウザ権限）", "ng");
    }
  });

  el("btnClearDebug").addEventListener("click", () => {
    clearDebug();
    pushStatus("Debugをクリアしました");
  });

  el("fileInput").addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if (f) loadFromLocalFile(f);
  });

  // 初回は自動同期（失敗しても理由がDebugに出る）
  syncFromUrl(true);
});
</script>
</body>
</html>
