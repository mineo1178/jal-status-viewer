<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAL Status & Flight Manager Pro</title>
    <!-- iOS Home Screen Icon & Web App Meta -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="apple-mobile-web-app-title" content="JAL Status">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --jal-red: #E10009;
            --jal-black: #000000;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
        }
        /* Desktop Sidebar Styles */
        #sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 64px;
        }
        #sidebar.expanded {
            width: 260px;
        }
        .sidebar-label {
            display: none;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .expanded .sidebar-label {
            display: inline;
            opacity: 1;
        }
        .nav-item.active {
            background-color: var(--jal-red);
            color: white;
            box-shadow: 0 4px 12px rgba(225, 0, 9, 0.2);
        }
        .nav-item:not(.active):hover {
            background-color: #1e293b;
            color: white;
        }
        /* Mobile Bottom Nav Styles */
        .mobile-nav-item.active {
            color: var(--jal-red);
        }

        .stat-card {
            border-left: 4px solid var(--jal-red);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        canvas {
            max-height: 320px;
            width: 100% !important;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
        }
        select, input[type="date"] {
            border: 1px solid #e2e8f0;
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            background-color: #fff;
            color: #475569;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f8fafc;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Sidebar (Desktop only) -->
    <aside id="sidebar" class="hidden md:flex bg-[#0f172a] text-slate-400 flex-col h-full z-50 shadow-2xl shrink-0">
        <div class="h-16 flex items-center px-4 border-b border-slate-800 shrink-0">
            <button id="toggleBtn" class="text-xl hover:text-white transition-colors w-8 h-8 flex items-center justify-center">
                <i class="fa-solid fa-bars"></i>
            </button>
            <span class="sidebar-label ml-4 font-bold text-white text-lg tracking-tight">JAL Asset Manager</span>
        </div>
        
        <nav class="flex-1 mt-6 space-y-2 px-3 overflow-y-auto">
            <button onclick="switchTab('dashboard')" class="nav-item w-full flex items-center p-3 rounded-xl transition-all active" data-tab="dashboard">
                <i class="fa-solid fa-gauge-high w-6 text-center text-lg"></i>
                <span class="sidebar-label ml-3 font-medium">ダッシュボード</span>
            </button>
            <button onclick="switchTab('miles')" class="nav-item w-full flex items-center p-3 rounded-xl transition-all" data-tab="miles">
                <i class="fa-solid fa-award w-6 text-center text-lg"></i>
                <span class="sidebar-label ml-3 font-medium">マイル管理</span>
            </button>
            <button onclick="switchTab('lsp')" class="nav-item w-full flex items-center p-3 rounded-xl transition-all" data-tab="lsp">
                <i class="fa-solid fa-star-half-stroke w-6 text-center text-lg"></i>
                <span class="sidebar-label ml-3 font-medium">LSP管理</span>
            </button>
            <button onclick="switchTab('flights')" class="nav-item w-full flex items-center p-3 rounded-xl transition-all" data-tab="flights">
                <i class="fa-solid fa-plane-departure w-6 text-center text-lg"></i>
                <span class="sidebar-label ml-3 font-medium">フライト管理</span>
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full min-w-0 pb-16 md:pb-0">
        <header class="h-14 md:h-16 bg-white border-b flex items-center justify-between px-4 md:px-8 shrink-0 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <h2 id="tabTitle" class="text-lg md:text-xl font-extrabold text-slate-800 tracking-tight">ダッシュボード</h2>
            </div>
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-slate-900 flex items-center justify-center text-white border-2 border-white shadow-md">
                    <i class="fa-solid fa-user-tie text-xs md:text-base"></i>
                </div>
            </div>
        </header>

        <div id="content" class="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar">
            
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content active space-y-6 md:space-y-8">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm stat-card border-l-[#E10009]">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Miles</p>
                        <div class="flex items-baseline gap-1 md:gap-2"><span id="stat-miles" class="text-xl md:text-3xl font-black text-slate-800">0</span><span class="text-[10px] font-bold text-slate-400">mile</span></div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm stat-card border-l-blue-500">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">LSP</p>
                        <div class="flex items-baseline gap-1 md:gap-2"><span id="stat-lsp" class="text-xl md:text-3xl font-black text-slate-800">0</span><span class="text-[10px] font-bold text-slate-400">pts</span></div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm stat-card border-l-orange-500">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Yearly FOP</p>
                        <div class="flex items-baseline gap-1 md:gap-2"><span id="stat-fop" class="text-xl md:text-3xl font-black text-slate-800">0</span><span class="text-[10px] font-bold text-slate-400">FOP</span></div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm stat-card border-l-emerald-500">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Flights</p>
                        <div class="flex items-baseline gap-1 md:gap-2"><span id="stat-yearly-flights" class="text-xl md:text-3xl font-black text-slate-800">0</span><span class="text-[10px] font-bold text-slate-400">回</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100">
                    <h3 class="font-black text-sm md:text-base text-slate-800 flex items-center gap-2 mb-4 md:mb-6">
                        <i class="fa-solid fa-chart-line text-[#E10009]"></i> 
                        <span>ステータス進捗</span>
                    </h3>
                    <div class="h-64 md:h-80"><canvas id="annualTrendChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100">
                        <h3 class="font-black text-sm md:text-base text-slate-800 flex items-center gap-2 mb-4 md:mb-6"><i class="fa-solid fa-chart-pie text-red-500"></i> <span id="dash-mile-pie-title">獲得マイル内訳</span></h3>
                        <div class="h-64"><canvas id="milePieChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100">
                        <h3 class="font-black text-sm md:text-base text-slate-800 flex items-center gap-2 mb-4 md:mb-6"><i class="fa-solid fa-chart-pie text-blue-500"></i> <span id="dash-lsp-pie-title">LSP獲得内訳</span></h3>
                        <div class="h-64"><canvas id="lspPieChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- DETAIL TAB -->
            <div id="tab-detail" class="tab-content space-y-6 md:space-y-8">
                <div id="flightSummarySection" class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 hidden">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Upcoming Flights</p>
                        <div class="flex items-baseline gap-2">
                            <span id="stat-planned-flights" class="text-3xl md:text-4xl font-black text-red-600">0</span>
                            <span class="text-xs font-bold text-slate-400">予定</span>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-3">Next Schedule</p>
                        <div id="flightCards" class="flex overflow-x-auto gap-3 no-scrollbar pb-1">
                            <p class="text-sm text-slate-400 italic">予定はありません</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8" id="analysisGrid">
                    <!-- Pie Chart & Category Table -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100 flex flex-col" id="pieChartContainer">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <h3 class="font-black text-sm md:text-base text-slate-800" id="detailPieTitle">内訳</h3>
                            <div class="text-[10px] font-black text-red-600 bg-red-50 px-3 py-1 rounded-full" id="totalEarnedValue">0</div>
                        </div>
                        <div class="h-64"><canvas id="detailPieChart"></canvas></div>
                        <div id="categorySummaryArea" class="mt-4 pt-4 border-t border-slate-50 hidden">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3">獲得種別詳細</p>
                            <div class="overflow-hidden rounded-xl border border-slate-50">
                                <table class="w-full text-left border-collapse">
                                    <tbody id="categorySummaryBody" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Line Chart & Monthly Pivot Table -->
                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100 flex flex-col" id="lineChartContainer">
                        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4 md:mb-6">
                            <h3 class="font-black text-sm md:text-base text-slate-800" id="detailLineTitle">実績</h3>
                            <div class="flex gap-2">
                                <input type="date" id="chartFilterStart" onchange="updateUI()" class="flex-1 md:flex-none">
                                <input type="date" id="chartFilterEnd" onchange="updateUI()" class="flex-1 md:flex-none">
                            </div>
                        </div>
                        <div class="h-64"><canvas id="detailLineChart"></canvas></div>
                        <div id="monthlySummaryArea" class="mt-4 pt-4 border-t border-slate-50 hidden">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3">月別詳細実績 (比率順)</p>
                            <div class="overflow-x-auto rounded-xl border border-slate-50 no-scrollbar">
                                <table class="w-full text-left border-collapse min-w-full">
                                    <thead id="monthlySummaryHead" class="bg-slate-50"></thead>
                                    <tbody id="monthlySummaryBody" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100 hidden lg:col-span-2" id="mileTrendSection">
                        <h3 class="font-black text-sm md:text-base text-slate-800 mb-6">マイル推移</h3>
                        <div class="h-64 md:h-80"><canvas id="mileMixedChart"></canvas></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100 hidden lg:col-span-2" id="lspTrendSection">
                        <h3 class="font-black text-sm md:text-base text-slate-800 mb-6">LSP累積推移</h3>
                        <div class="h-64 md:h-80"><canvas id="lspMixedChart"></canvas></div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm p-4 md:p-6 border border-slate-100 hidden lg:col-span-2" id="rankingSection">
                        <h3 class="font-black text-sm md:text-base text-slate-800 mb-6">区間ランキング</h3>
                        <div class="h-64 md:h-80"><canvas id="rankingChart"></canvas></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b border-slate-50 flex flex-wrap items-center justify-between gap-3">
                        <h3 class="font-bold text-slate-800">データ明細</h3>
                        <div class="flex flex-wrap gap-2 w-full md:w-auto">
                            <select id="monthSelector" onchange="updateUI()" class="flex-1 md:flex-none hidden"></select>
                            <select id="categorySelector" onchange="updateUI()" class="flex-1 md:flex-none"></select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="w-full text-left border-collapse min-w-[500px]">
                            <thead id="table-head" class="sticky top-0 bg-white z-10 shadow-sm border-b"></thead>
                            <tbody id="table-body" class="divide-y divide-slate-50 text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 h-16 flex items-center justify-around z-50 shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
            <button onclick="switchTab('dashboard')" class="mobile-nav-item flex flex-col items-center gap-1 active" data-tab-mob="dashboard">
                <i class="fa-solid fa-gauge-high text-lg"></i>
                <span class="text-[10px] font-bold">ダッシュ</span>
            </button>
            <button onclick="switchTab('miles')" class="mobile-nav-item flex flex-col items-center gap-1" data-tab-mob="miles">
                <i class="fa-solid fa-award text-lg"></i>
                <span class="text-[10px] font-bold">マイル</span>
            </button>
            <button onclick="switchTab('lsp')" class="mobile-nav-item flex flex-col items-center gap-1" data-tab-mob="lsp">
                <i class="fa-solid fa-star-half-stroke text-lg"></i>
                <span class="text-[10px] font-bold">LSP</span>
            </button>
            <button onclick="switchTab('flights')" class="mobile-nav-item flex flex-col items-center gap-1" data-tab-mob="flights">
                <i class="fa-solid fa-plane-departure text-lg"></i>
                <span class="text-[10px] font-bold">フライト</span>
            </button>
        </nav>
    </main>

    <script>
        // --- State ---
        let appData = { plans: [], lsp: [], miles: [], stats: { miles: 0, lsp: 0, fop: 0, yearlyFlights: 0, plannedFlights: 0 } };
        let currentTab = 'dashboard';
        let charts = {};
        const EXCEL_URL = "https://raw.githubusercontent.com/mineo1178/jal-status-viewer/main/data/20251229_LSP%E7%AE%A1%E7%90%86.xlsx";

        const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
        const safeSetHTML = (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; };

        // --- Helpers ---
        function parseDate(val) {
            if (!val) return "";
            if (val instanceof Date) return val.toISOString().split('T')[0];
            if (typeof val === 'number') { 
                const d = new Date((val - 25569) * 86400 * 1000); 
                return d.toISOString().split('T')[0];
            }
            let str = String(val).replace(/\//g, '-').trim();
            if (str.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) return str;
            return str;
        }

        function getDayOfWeek(dateStr) {
            if(!dateStr) return "";
            const days = ["日", "月", "火", "水", "木", "金", "土"];
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? "" : `(${days[d.getDay()]})`;
        }

        // --- Initialization ---
        window.onload = async () => {
            const today = new Date();
            const sixMonthsAgo = new Date(); sixMonthsAgo.setMonth(today.getMonth() - 6);
            if (document.getElementById('chartFilterStart')) document.getElementById('chartFilterStart').value = sixMonthsAgo.toISOString().split('T')[0];
            if (document.getElementById('chartFilterEnd')) document.getElementById('chartFilterEnd').value = today.toISOString().split('T')[0];
            await syncFromUrl();
        };

        // --- Navigation ---
        document.getElementById('toggleBtn').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('expanded'); });

        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.tab === tabId));
            document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.toggle('active', el.dataset.tabMob === tabId));
            document.getElementById('tabTitle').innerText = { 'dashboard': 'ダッシュボード', 'miles': 'マイル管理', 'lsp': 'LSP管理', 'flights': 'フライト管理' }[tabId];
            
            const dashTab = document.getElementById('tab-dashboard');
            const detailTab = document.getElementById('tab-detail');
            const pieContainer = document.getElementById('pieChartContainer');
            const lineContainer = document.getElementById('lineChartContainer');
            const flightSummary = document.getElementById('flightSummarySection');
            const mileTrend = document.getElementById('mileTrendSection');
            const lspTrend = document.getElementById('lspTrendSection');

            if (dashTab) dashTab.classList.toggle('active', tabId === 'dashboard');
            if (detailTab) detailTab.classList.toggle('active', tabId !== 'dashboard');
            if (pieContainer) pieContainer.classList.remove('hidden');
            if (lineContainer) lineContainer.classList.remove('lg:col-span-2');
            if (flightSummary) flightSummary.classList.add('hidden');
            if (mileTrend) mileTrend.classList.add('hidden');
            if (lspTrend) lspTrend.classList.add('hidden');

            if (tabId === 'flights') {
                if (pieContainer) pieContainer.classList.add('hidden');
                if (lineContainer) lineContainer.classList.add('lg:col-span-2');
                if (flightSummary) flightSummary.classList.remove('hidden');
            } else if (tabId === 'miles') {
                if (mileTrend) mileTrend.classList.remove('hidden');
            } else if (tabId === 'lsp') {
                if (lspTrend) lspTrend.classList.remove('hidden');
            }
            updateUI();
        }

        // --- Logic ---
        async function syncFromUrl() {
            try {
                const response = await fetch(EXCEL_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const buffer = await response.arrayBuffer();
                const wb = XLSX.read(buffer, { cellDates: true });
                wb.SheetNames.forEach(name => processRows(name, XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 })));
                updateUI();
            } catch (e) { console.error("Sync Error:", e.message); }
        }

        function processRows(sheetName, rows) {
            const findHeader = (kw) => rows.findIndex(r => r && r.some(c => typeof c === 'string' && kw.some(k => c.includes(k))));
            
            if (sheetName.includes('LSP') || findHeader(['積算日']) !== -1) {
                const idx = findHeader(['積算日']); if (idx === -1) return;
                const h = rows[idx];
                const validRows = rows.slice(idx + 1).filter(r => r && r[h.indexOf('積算日')]);
                appData.lsp = validRows.map((r, i) => {
                    const o = { _idx: i, date: parseDate(r[h.indexOf('積算日')]), category: r[h.indexOf('カテゴリー')] || '不明', points: parseFloat(r[h.indexOf('ポイント')]) || 0, total: parseFloat(r[h.indexOf('累積ポイント')]) || 0, content: r[h.indexOf('内容')], service: r[h.indexOf('サービス')] || "" };
                    o.ui_category = categorizeLSP(o); return o;
                }).filter(i => i.date && i.date.match(/^\d{4}/));
            }
            else if (sheetName.includes('マイル') || findHeader(['有効マイル']) !== -1) {
                const idx = findHeader(['有効マイル']); if (idx === -1) return;
                appData.miles = rows.slice(idx + 1).filter(r => r && r[0]).map((r, i) => {
                    const o = { _idx: i, date: parseDate(r[0]), content: r[1], gain: parseInt(r[7]) || 0, total: parseInt(r[8]) || 0, fop: parseInt(r[9]) || 0, flight_count: parseInt(r[10]) || 0 };
                    o.ui_category = categorizeMile(o.content); return o;
                }).filter(i => i.date && i.date.match(/^\d{4}/));
            }
            else if (sheetName.includes('計画') || findHeader(['出発地']) !== -1) {
                const idx = findHeader(['出発地']); if (idx === -1) return;
                const h = rows[idx];
                appData.plans = rows.slice(idx + 1).filter(r => r && r[h.indexOf('日付')]).map(r => ({
                    date: parseDate(r[h.indexOf('日付')]), airline: r[h.indexOf('運航会社')], flightNo: r[h.indexOf('便名')], from: r[h.indexOf('出発地')], to: r[h.indexOf('到着地')], depTime: r[h.indexOf('出発時刻')], arrTime: r[h.indexOf('到着時刻')], status: r[h.indexOf('結果')] || '予定'
                })).filter(i => i.date && i.date.match(/^\d{4}/));
            }
        }

        function categorizeMile(c) {
            c = String(c || "");
            if (c.match(/[A-Z]{2,3}\d+/) || ["羽田","那覇","福岡","石垣","宮古","成田","伊丹","HND","FUK","OKA"].some(k => c.includes(k))) return "フライト獲得";
            if (c.includes("カード") || c.includes("ClubQ")) return "JALカード決済";
            if (c.includes("Wellness") || c.includes("ＷＥＬＬＮＥＳＳ")) return "Wellness";
            if (c.includes("キャンペーン") || c.includes("ボーナス") || c.includes("プレゼント")) return "特典/CP";
            if (c.includes("交換") || c.includes("ポイント") || c.includes("Ｐｏｎｔａ") || c.includes("ｄポイント")) return "ポイント交換";
            if (c.includes("Mall") || c.includes("モール") || c.includes("ショッピング") || c.includes("特約店")) return "ショッピング";
            if (c.includes("アンケート") || c.includes("モニター") || c.includes("ご意見")) return "アンケート";
            return "その他獲得";
        }

        function categorizeLSP(item) {
            const cat = String(item.category || "");
            const srv = String(item.service || "");
            if (cat.includes("航空")) return srv.includes("国内") ? "航空: 国内線" : "航空: 国際線";
            if (cat.includes("ライフ")) {
                if (srv.includes("カード")) return "ライフ: カード決済";
                if (srv.includes("Pay") || srv.includes("モバイル")) return "ライフ: モバイル/Pay";
                if (srv.includes("Wellness")) return "ライフ: Wellness";
                if (srv.includes("Mall") || srv.includes("ショッピング") || srv.includes("公共") || srv.includes("保険")) return "ライフ: ショッピング";
                return "ライフ: その他";
            }
            return "その他獲得";
        }

        function updateUI() {
            const todayStr = new Date().toISOString().split('T')[0];
            const currentYear = new Date().getFullYear().toString();
            if (appData.miles.length > 0) {
                const s = [...appData.miles].sort((a,b) => b.date.localeCompare(a.date) || b._idx - a._idx);
                appData.stats.miles = s[0].total; 
                const ym = appData.miles.filter(m => m.date.startsWith(currentYear));
                appData.stats.fop = ym.reduce((sum, m) => sum + (parseInt(m.fop)||0), 0);
                appData.stats.yearlyFlights = ym.reduce((sum, m) => sum + (parseInt(m.flight_count)||0), 0);
            }
            if (appData.lsp.length > 0) { 
                const s = [...appData.lsp].sort((a,b) => b.date.localeCompare(a.date) || b._idx - a._idx);
                appData.stats.lsp = s[0].total; 
            }
            if (appData.plans.length > 0) appData.stats.plannedFlights = appData.plans.filter(p => p.status !== '済' && p.date >= todayStr).length;

            safeSetText('stat-miles', appData.stats.miles.toLocaleString());
            safeSetText('stat-lsp', appData.stats.lsp.toLocaleString());
            safeSetText('stat-fop', appData.stats.fop.toLocaleString());
            safeSetText('stat-yearly-flights', `${appData.stats.yearlyFlights.toLocaleString()} (${appData.stats.plannedFlights})`);

            if (currentTab === 'dashboard') updateDashboard();
            else {
                const cS = document.getElementById('chartFilterStart').value;
                const cE = document.getElementById('chartFilterEnd').value;
                const catSelValue = document.getElementById('categorySelector')?.value || 'all';
                const listF = (list, start, end) => list.filter(i => (!start || i.date >= start) && (!end || i.date <= end));
                if (currentTab === 'miles') updateMilesTab(listF(appData.miles, cS, cE), catSelValue);
                else if (currentTab === 'lsp') updateLSPTab(listF(appData.lsp, cS, cE), catSelValue);
                else if (currentTab === 'flights') updateFlightsTab(listF(appData.plans, cS, cE));
            }
        }

        function renderCategorySummary(groups, unit) {
            const area = document.getElementById('categorySummaryArea');
            const body = document.getElementById('categorySummaryBody');
            if (!area || !body) return;
            area.classList.remove('hidden');
            const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);
            const total = sorted.reduce((s, x) => s + x[1], 0);
            body.innerHTML = sorted.map(([cat, val]) => `
                <tr class="hover:bg-slate-50/50">
                    <td class="py-2 px-3 text-slate-600 font-bold text-[10px] md:text-xs">${cat}</td>
                    <td class="py-2 px-3 text-right font-black text-slate-800 text-[10px] md:text-xs">${val.toLocaleString()} <span class="text-[8px] font-bold text-slate-400">${unit}</span></td>
                    <td class="py-2 px-3 text-right text-[9px] font-bold text-slate-400 w-12">${total > 0 ? (val/total*100).toFixed(1) : 0}%</td>
                </tr>
            `).join('');
        }

        // 月別詳細表のレンダリング（最新月が左、比率順でソート、画面サイズ対応）
        function renderMonthlySummary(list, key, unit) {
            const area = document.getElementById('monthlySummaryArea');
            const head = document.getElementById('monthlySummaryHead');
            const body = document.getElementById('monthlySummaryBody');
            if (!area || !head || !body) return;
            area.classList.remove('hidden');

            const isMobile = window.innerWidth < 768;
            const displayCount = isMobile ? 3 : 6;

            // 最新月を特定し、そこから過去へ向かってラベル生成
            const sortedList = [...list].sort((a,b) => b.date.localeCompare(a.date));
            if (sortedList.length === 0) { area.classList.add('hidden'); return; }
            
            const latestDate = new Date(sortedList[0].date);
            const months = [];
            for (let i = 0; i < displayCount; i++) {
                const d = new Date(latestDate.getFullYear(), latestDate.getMonth() - i, 1);
                months.push(d.toISOString().substring(0, 7)); // "YYYY-MM"
            }

            // カテゴリの合計値を計算して、降順（比率の高い順）にソート
            const categories = [...new Set(list.map(d => d.ui_category))];
            const catStats = categories.map(cat => {
                const total = list.filter(d => d.ui_category === cat).reduce((s, d) => s + (d[key] > 0 ? d[key] : 0), 0);
                return { name: cat, total };
            }).sort((a, b) => b.total - a.total);

            // ヘッダー生成
            let headHtml = `<tr><th class="py-2 px-3 text-[9px] font-black text-slate-400 uppercase text-left">カテゴリ</th>`;
            months.forEach(m => {
                headHtml += `<th class="py-2 px-3 text-[9px] font-black text-slate-400 uppercase text-right">${m.split('-')[1]}月</th>`;
            });
            headHtml += `<th class="py-2 px-3 text-[9px] font-black text-slate-400 uppercase text-right bg-slate-100/50">全体合計</th></tr>`;
            head.innerHTML = headHtml;

            // ボディ生成
            let bodyHtml = "";
            catStats.forEach(cat => {
                bodyHtml += `<tr><td class="py-2 px-3 text-slate-600 font-bold text-[10px] md:text-xs whitespace-nowrap">${cat.name}</td>`;
                months.forEach(m => {
                    const val = list.filter(d => d.date.startsWith(m) && d.ui_category === cat.name).reduce((s, d) => s + (d[key] > 0 ? d[key] : 0), 0);
                    bodyHtml += `<td class="py-2 px-3 text-right text-slate-800 text-[10px] md:text-xs ${val === 0 ? 'text-slate-300' : 'font-bold'}">${val > 0 ? val.toLocaleString() : '-'}</td>`;
                });
                bodyHtml += `<td class="py-2 px-3 text-right font-black text-slate-800 text-[10px] md:text-xs bg-slate-100/30">${cat.total.toLocaleString()}</td></tr>`;
            });
            body.innerHTML = bodyHtml;
        }

        function updateDashboard() {
            const curMonth = new Date().getMonth();
            const ym = appData.miles.filter(m => m.date.startsWith(new Date().getFullYear()));
            const mFop = Array(12).fill(0), mFl = Array(12).fill(0);
            ym.forEach(m => { const idx = parseInt(m.date.split('-')[1]) - 1; if(idx>=0 && idx<12) { mFop[idx] += (parseInt(m.fop)||0); mFl[idx] += (parseInt(m.flight_count)||0); }});
            let rF = 0, rL = 0;
            const cF = mFop.map((v, i) => i <= curMonth ? (rF += v) : null);
            const cL = mFl.map((v, i) => i <= curMonth ? (rL += v) : null);
            try { renderMixedChart('annualTrendChart', Array.from({length:12}, (_,i)=>`${i+1}月`), cF, cL); } catch(e){}
            try { renderPieChart('milePieChart', appData.miles.reduce((g, d) => ({...g, [d.ui_category]: (g[d.ui_category]||0) + (d.gain > 0 ? d.gain : 0)}), {})); } catch(e){}
            try { renderPieChart('lspPieChart', appData.lsp.reduce((g, d) => ({...g, [d.ui_category]: (g[d.ui_category]||0) + d.points}), {})); } catch(e){}
        }

        function updateMilesTab(chartData, catFilter) {
            safeSetText('detailLineTitle', '月別マイル獲得実績');
            document.getElementById('rankingSection').classList.add('hidden');
            const groups = chartData.reduce((g, d) => ({...g, [d.ui_category]: (g[d.ui_category]||0) + (d.gain > 0 ? d.gain : 0)}), {});
            try { renderPieChart('detailPieChart', groups); } catch(e){}
            renderCategorySummary(groups, 'mile');
            renderMonthlySummary(chartData, 'gain', 'mile');
            try { renderStackedBar('detailLineChart', chartData, 'gain'); } catch(e){}
            try { renderMixedTrendChart('mileMixedChart', chartData, 'gain', 'total', '獲得', '残高', '#1e293b', '#E10009'); } catch(e){}
            const sel = document.getElementById('categorySelector');
            if (sel) {
                const cats = ['all', ...new Set(appData.miles.map(m => m.ui_category))].sort();
                sel.innerHTML = cats.map(c => `<option value="${c}" ${c === catFilter ? 'selected' : ''}>${c === 'all' ? '全て表示' : c}</option>`).join('');
            }
            const filtered = appData.miles.filter(m => catFilter === 'all' || m.ui_category === catFilter).sort((a, b) => b.date.localeCompare(a.date) || b._idx - a._idx);
            safeSetText('totalEarnedValue', `合計: ${filtered.reduce((s, m) => s + (m.gain > 0 ? m.gain : 0), 0).toLocaleString()} mile`);
            safeSetHTML('table-head', `<tr><th class="p-3">日付</th><th class="p-3">カテゴリ</th><th class="p-3">内容</th><th class="p-3 text-right">獲得</th><th class="p-3 text-right">残高</th></tr>`);
            safeSetHTML('table-body', filtered.map(m => `<tr class="border-b"><td class="p-3 whitespace-nowrap">${m.date}</td><td class="p-3 text-[10px] font-bold">${m.ui_category}</td><td class="p-3 font-bold">${m.content}</td><td class="p-3 text-right text-red-500 font-black">${m.gain > 0 ? '+' : ''}${m.gain.toLocaleString()}</td><td class="p-3 text-right font-bold">${m.total.toLocaleString()}</td></tr>`).join(''));
        }

        function updateLSPTab(chartData, catFilter) {
            safeSetText('detailLineTitle', '月別LSP獲得実績');
            document.getElementById('rankingSection').classList.add('hidden');
            const groups = chartData.reduce((g, d) => ({...g, [d.ui_category]: (g[d.ui_category]||0)+d.points}), {});
            try { renderPieChart('detailPieChart', groups); } catch(e){}
            renderCategorySummary(groups, 'LSP');
            renderMonthlySummary(chartData, 'points', 'LSP');
            try { renderStackedBar('detailLineChart', chartData, 'points'); } catch(e){}
            try { renderMixedTrendChart('lspMixedChart', chartData, 'points', 'total', '獲得', '累計', '#1e293b', '#3b82f6'); } catch(e){}
            const sel = document.getElementById('categorySelector');
            if (sel) {
                const cats = ['all', ...new Set(appData.lsp.map(l => l.ui_category))].sort();
                sel.innerHTML = cats.map(c => `<option value="${c}" ${c === catFilter ? 'selected' : ''}>${c === 'all' ? '全て表示' : c}</option>`).join('');
            }
            const filtered = appData.lsp.filter(l => catFilter === 'all' || l.ui_category === catFilter).sort((a, b) => b.date.localeCompare(a.date) || b._idx - a._idx);
            safeSetText('totalEarnedValue', `合計: ${filtered.reduce((s, l) => s + l.points, 0).toLocaleString()} LSP`);
            safeSetHTML('table-head', `<tr><th class="p-3">日付</th><th class="p-3">カテゴリ</th><th class="p-3">内容</th><th class="p-3 text-right">獲得</th><th class="p-3 text-right">累計</th></tr>`);
            safeSetHTML('table-body', filtered.map(l => `<tr class="border-b"><td class="p-3 whitespace-nowrap">${l.date}</td><td class="p-3 text-[10px] font-bold">${l.ui_category}</td><td class="p-3 font-bold">${l.content}</td><td class="p-3 text-right text-blue-500 font-black">+${l.points.toLocaleString()}</td><td class="p-3 text-right font-bold">${l.total.toLocaleString()}</td></tr>`).join(''));
        }

        function updateFlightsTab(chartData) {
            safeSetText('detailLineTitle', '月別搭乗実績');
            document.getElementById('rankingSection').classList.remove('hidden');
            document.getElementById('categorySummaryArea')?.classList.add('hidden');
            document.getElementById('monthlySummaryArea')?.classList.add('hidden');
            try { renderFlightStackedBar('detailLineChart', chartData); } catch(e){}
            const todayStr = new Date().toISOString().split('T')[0];
            const upcoming = appData.plans.filter(p => p.status !== '済' && p.date >= todayStr).sort((a,b)=>a.date.localeCompare(b.date));
            safeSetText('stat-planned-flights', upcoming.length);
            safeSetHTML('flightCards', upcoming.map(p => `<div class="bg-red-50 border border-red-100 p-3 rounded-xl min-w-[180px]"><p class="text-[10px] font-bold text-red-400">${p.date} ${getDayOfWeek(p.date)}</p><p class="text-xs font-black text-slate-800">${p.from} → ${p.to}</p></div>`).join('') || '<p class="text-xs text-slate-400 italic">予定なし</p>');
            const routes = {}; appData.plans.forEach(p => { if(p.status==='済'){ const r = `${p.from}→${p.to}`; routes[r] = (routes[r]||0)+1; }});
            try { renderRankingBarChart('rankingChart', Object.entries(routes).sort((a,b) => b[1] - a[1])); } catch(e){}
            safeSetHTML('table-head', `<tr><th class="p-3">日付/時刻</th><th class="p-3">便名</th><th class="p-3">区間</th><th class="p-3 text-center">結果</th></tr>`);
            safeSetHTML('table-body', appData.plans.sort((a,b)=>b.date.localeCompare(a.date)).map(p => `<tr class="border-b"><td class="p-3 font-bold text-xs">${p.date}<br><span class="text-slate-400 font-normal">${p.depTime || '--:--'}</span></td><td class="p-3 text-xs font-mono">${p.airline || ''}${p.flightNo || ''}</td><td class="p-3 font-bold">${p.from}→${p.to}</td><td class="p-3 text-center"><span class="px-2 py-1 rounded-full text-[9px] font-black ${p.status==='済'?'bg-slate-100 text-slate-400':'bg-red-600 text-white'}">${p.status}</span></td></tr>`).join(''));
        }

        // --- Charts ---
        function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }
        const chartOptions = (legendPos = 'right') => ({ responsive: true, maintainAspectRatio: false, plugins: { legend: { position: legendPos, labels: { font: { size: 9, weight: 'bold' }, boxWidth: 10 } } } });

        function renderMixedChart(id, labels, fop, fl) {
            const ctx = document.getElementById(id).getContext('2d'); destroyChart(id);
            const isMob = window.innerWidth < 768;
            charts[id] = new Chart(ctx, { data: { labels, datasets: [{ type: 'line', label: '累計 FOP', data: fop, borderColor: '#E10009', borderWidth: 3, fill: true, backgroundColor: 'rgba(225,0,9,0.05)', tension:0.3, yAxisID: 'y' }, { type: 'bar', label: '累計 搭乗', data: fl, backgroundColor: '#1e293b', borderRadius: 4, yAxisID: 'y1' }]}, options: { ...chartOptions(isMob?'bottom':'right'), scales: { y: { beginAtZero: true }, y1: { position: 'right', beginAtZero: true, grid: { display: false } } } } });
        }

        function renderPieChart(id, groups) {
            const ctx = document.getElementById(id).getContext('2d'); destroyChart(id);
            const labels = Object.keys(groups).sort((a,b) => groups[b] - groups[a]);
            const isMob = window.innerWidth < 768;
            charts[id] = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: labels.map(l => groups[l]), backgroundColor: ['#E10009', '#1e293b', '#10b981', '#3b82f6', '#f59e0b', '#db2777', '#8b5cf6', '#94a3b8'], borderWidth: 0 }] }, options: chartOptions(isMob?'bottom':'right') });
        }

        // 積層棒グラフ（比率の多いカテゴリを下に配置して描画）
        function renderStackedBar(id, list, key) {
            const ctx = document.getElementById(id).getContext('2d'); destroyChart(id);
            const months = [...new Set(list.map(d => d.date.substring(0, 7)))].sort();
            
            // 全期間の合計でカテゴリをソート（多い順）
            const categories = [...new Set(list.map(d => d.ui_category))];
            const sortedCats = categories.map(cat => {
                const total = list.filter(d => d.ui_category === cat).reduce((s, d) => s + (d[key] > 0 ? d[key] : 0), 0);
                return { name: cat, total };
            }).sort((a, b) => b.total - a.total).map(c => c.name);

            const colors = ['#E10009', '#1e293b', '#10b981', '#3b82f6', '#f59e0b', '#db2777', '#8b5cf6', '#94a3b8'];
            
            charts[id] = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: months, 
                    // datasetsの順序を比率順（多い順）にすることで、グラフ下部から積み上がる
                    datasets: sortedCats.map((c, i) => ({ 
                        label: c, 
                        backgroundColor: colors[i % colors.length], 
                        data: months.map(m => list.filter(d => d.date.substring(0, 7) === m && d.ui_category === c).reduce((s, d) => s + (d[key] > 0 ? d[key] : 0), 0)), 
                        borderRadius: 3 
                    })) 
                }, 
                options: { 
                    ...chartOptions(window.innerWidth < 768?'bottom':'right'), 
                    scales: { x: { stacked: true }, y: { stacked: true } } 
                } 
            });
        }

        function renderMixedTrendChart(id, list, bK, lK, bL, lL, bC, lO) {
            const ctx = document.getElementById(id).getContext('2d'); destroyChart(id);
            const sorted = [...list].sort((a,b)=>a.date.localeCompare(b.date));
            const dates = [...new Set(sorted.map(d => d.date))];
            charts[id] = new Chart(ctx, { data: { labels: dates, datasets: [{ type: 'line', label: lL, data: dates.map(d => sorted.filter(i => i.date === d).pop()[lK]), borderColor: lO, borderWidth: 2, fill: false, pointRadius: 1, yAxisID: 'y' }, { type: 'bar', label: bL, data: dates.map(d => sorted.filter(i => i.date === d).reduce((s, i) => s + (i[bK] > 0 ? i[bK] : 0), 0)), backgroundColor: bC, yAxisID: 'y1' }] }, options: { ...chartOptions(window.innerWidth < 768?'bottom':'right'), scales: { y: { position: 'left' }, y1: { position: 'right', grid: { display: false } } } } });
        }

        function renderFlightStackedBar(id, list) {
            const ctx = document.getElementById(id).getContext('2d'); destroyChart(id);
            const today = new Date();
            const months = []; for (let i = -3; i <= 3; i++) { const d = new Date(today.getFullYear(), today.getMonth() + i, 1); months.push(d.toISOString().substring(0, 7)); }
            charts[id] = new Chart(ctx, { type: 'bar', data: { labels: months, datasets: [{ label: '済', backgroundColor: '#1e293b', data: months.map(m => list.filter(d => d.date.startsWith(m) && d.status === '済').length) }, { label: '予定', backgroundColor: '#E10009', data: months.map(m => list.filter(d => d.date.startsWith(m) && d.status !== '済').length) }] }, options: { ...chartOptions('bottom'), scales: { x: { stacked: true }, y: { stacked: true, ticks: { stepSize: 1 } } } } });
        }

        function renderRankingBarChart(id, data) {
            const ctx = document.getElementById(id).getContext('2d'); destroyChart(id);
            charts[id] = new Chart(ctx, { type: 'bar', data: { labels: data.map(d => d[0]), datasets: [{ label: '回数', data: data.map(d => d[1]), backgroundColor: '#E10009', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }
    </script>
</body>
</html>