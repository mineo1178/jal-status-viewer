<!-- gv4.20 - GitHub Raw Auto Load Edition -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JAL Status & Flight Manager (GitHub Raw)</title>

  <!-- Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root { --jal-red:#E10009; }
    body { background:#f1f5f9; }
    canvas { max-height: 320px; }
    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,.9); z-index:1000; display:none; align-items:center; justify-content:center; flex-direction:column; }
    .spinner { border:4px solid #f3f3f3; border-top:4px solid var(--jal-red); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .nav-item.active { background:var(--jal-red); color:#fff; }
    .table-container { max-height: 60vh; overflow:auto; }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

  <!-- Loading -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner mb-4"></div>
    <p id="loadingText" class="font-bold text-slate-700">読み込み中...</p>
    <p id="loadingSub" class="text-xs text-slate-500 mt-1"></p>
  </div>

  <!-- Top bar -->
  <header class="bg-slate-900 text-white px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-plane text-red-500"></i>
      <span class="font-extrabold tracking-tight">JAL Status Viewer</span>
      <span class="text-xs text-slate-300">gv4.20</span>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnSync" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2">
        <i class="fa-solid fa-rotate"></i> 自動URLから同期
      </button>

      <label class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-xs font-bold cursor-pointer flex items-center gap-2">
        <i class="fa-solid fa-file-excel"></i> ローカルExcel
        <input type="file" id="fileInput" class="hidden" accept=".xlsx,.csv">
      </label>
    </div>
  </header>

  <!-- Main -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-56 bg-white border-r p-3 overflow-y-auto">
      <button class="nav-item w-full text-left px-3 py-2 rounded-lg font-bold text-slate-700 hover:bg-slate-100 active" data-tab="dashboard">
        <i class="fa-solid fa-gauge-high mr-2"></i> ダッシュボード
      </button>
      <button class="nav-item w-full text-left px-3 py-2 rounded-lg font-bold text-slate-700 hover:bg-slate-100 mt-2" data-tab="miles">
        <i class="fa-solid fa-award mr-2"></i> マイル管理
      </button>
      <button class="nav-item w-full text-left px-3 py-2 rounded-lg font-bold text-slate-700 hover:bg-slate-100 mt-2" data-tab="lsp">
        <i class="fa-solid fa-star mr-2"></i> LSP管理
      </button>
      <button class="nav-item w-full text-left px-3 py-2 rounded-lg font-bold text-slate-700 hover:bg-slate-100 mt-2" data-tab="flights">
        <i class="fa-solid fa-plane-departure mr-2"></i> フライト管理
      </button>

      <div class="mt-4 p-3 bg-slate-50 rounded-xl border">
        <p class="text-xs font-black text-slate-500">自動読み込みURL</p>
        <p id="excelUrlView" class="text-[11px] text-slate-600 break-all mt-1"></p>
        <p id="lastSync" class="text-[11px] text-slate-500 mt-2"></p>
      </div>
    </aside>

    <!-- Content -->
    <main class="flex-1 overflow-y-auto p-4 md:p-6">

      <!-- Dashboard -->
      <section id="tab-dashboard" class="tab-content active space-y-4">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded-xl border p-4">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Miles</p>
            <p class="text-2xl font-black text-slate-800" id="stat-miles">0</p>
          </div>
          <div class="bg-white rounded-xl border p-4">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">LSP</p>
            <p class="text-2xl font-black text-slate-800" id="stat-lsp">0</p>
          </div>
          <div class="bg-white rounded-xl border p-4">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">FOP (This year)</p>
            <p class="text-2xl font-black text-slate-800" id="stat-fop">0</p>
          </div>
          <div class="bg-white rounded-xl border p-4">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Flights (This year)</p>
            <p class="text-2xl font-black text-slate-800" id="stat-yearly-flights">0</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-white rounded-xl border p-4">
            <h3 class="font-black text-slate-800 text-sm mb-2"><i class="fa-solid fa-chart-pie text-red-500 mr-2"></i>マイル内訳（簡易）</h3>
            <div class="h-56"><canvas id="milePieChart"></canvas></div>
          </div>
          <div class="bg-white rounded-xl border p-4">
            <h3 class="font-black text-slate-800 text-sm mb-2"><i class="fa-solid fa-chart-pie text-blue-500 mr-2"></i>LSP内訳（簡易）</h3>
            <div class="h-56"><canvas id="lspPieChart"></canvas></div>
          </div>
        </div>

        <div class="bg-white rounded-xl border p-4">
          <h3 class="font-black text-slate-800 text-sm mb-2"><i class="fa-solid fa-list mr-2 text-slate-700"></i>直近読み込み状況</h3>
          <pre id="debugInfo" class="text-[11px] bg-slate-50 border rounded-lg p-3 overflow-x-auto"></pre>
        </div>
      </section>

      <!-- Detail -->
      <section id="tab-detail" class="tab-content space-y-4">
        <div class="bg-white rounded-xl border overflow-hidden">
          <div class="p-3 border-b flex items-center justify-between">
            <h3 id="detailTitle" class="font-black text-slate-800 text-sm">明細</h3>
            <select id="categorySelector" class="text-xs border rounded-lg px-2 py-1"></select>
          </div>
          <div class="table-container">
            <table class="w-full text-left border-collapse">
              <thead class="sticky top-0 bg-white z-10 border-b">
                <tr class="text-[11px] uppercase text-slate-400 font-black">
                  <th class="p-3">日付</th>
                  <th class="p-3">内容</th>
                  <th class="p-3 text-right">値</th>
                </tr>
              </thead>
              <tbody id="table-body" class="divide-y text-xs"></tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

<script>
/**
 * gv4.20 - GitHub Raw Auto Load Edition
 * - GitHub Raw URLからExcelを自動取得してSheetJSで解析
 * - ローカルExcel読み込みも残す
 */

// ★あなたのURL（ここが今回の肝）
const EXCEL_URL = "https://github.com/mineo1178/jal-status-viewer/raw/refs/heads/main/data/20251229_LSP%E7%AE%A1%E7%90%86.xlsx";

document.getElementById("excelUrlView").innerText = EXCEL_URL;

let appData = {
  plans: [],
  lsp: [],
  miles: [],
  stats: { miles: 0, lsp: 0, fop: 0, yearlyFlights: 0, plannedFlights: 0 }
};
let currentTab = "dashboard";
let charts = {};

function showLoading(msg, sub="") {
  document.getElementById("loadingText").innerText = msg;
  document.getElementById("loadingSub").innerText = sub;
  document.getElementById("loadingOverlay").style.display = "flex";
}
function hideLoading() {
  document.getElementById("loadingOverlay").style.display = "none";
}
function safeSetText(id, text) {
  const el = document.getElementById(id);
  if (el) el.innerText = text;
}

function parseDate(val) {
  if (!val) return "";
  if (val instanceof Date) return val.toISOString().split("T")[0];
  if (typeof val === "number") {
    // Excel serial date
    const d = new Date((val - 25569) * 86400 * 1000);
    return isNaN(d.getTime()) ? "" : d.toISOString().split("T")[0];
  }
  return String(val).trim().replace(/\//g, "-");
}

function categorizeMile(content) {
  const c = String(content || "");
  if (c.match(/[A-Z]{2,3}\d+/) || ["羽田","那覇","福岡","石垣","宮古","成田","伊丹","HND","FUK","OKA","KIX","ITM"].some(k => c.includes(k))) return "フライト";
  if (c.includes("カード") || c.includes("Club") || c.includes("決済")) return "カード";
  if (c.includes("Wellness")) return "Wellness";
  return "その他";
}

function categorizeLsp(category, service) {
  const cat = String(category || "");
  const serv = String(service || "");
  if (cat.includes("航空")) return serv.includes("国内") ? "航空:国内" : "航空:その他";
  if (cat.includes("ライフ")) return "ライフスタイル";
  return "その他";
}

function resetDataKeepStats() {
  const st = { ...appData.stats };
  appData = { plans: [], lsp: [], miles: [], stats: st };
}

function processRows(sheetName, rows) {
  const findHeader = (keywords) =>
    rows.findIndex(r => r && r.some(c => typeof c === "string" && keywords.some(k => c.includes(k))));

  // LSP
  if (sheetName.includes("LSP") || findHeader(["積算日"]) !== -1) {
    const idx = findHeader(["積算日"]);
    if (idx < 0) return;
    const header = rows[idx];
    const col = (name) => header.indexOf(name);

    const cDate = col("積算日");
    const cCat = col("カテゴリー");
    const cSvc = col("サービス");
    const cCnt = col("内容");
    const cPt  = col("ポイント");
    const cTot = col("累積ポイント");

    const body = rows.slice(idx + 1).filter(r => r && r[cDate]);
    appData.lsp = body.map((r, i) => {
      const date = parseDate(r[cDate]);
      const category = r[cCat] ?? "不明";
      const service = r[cSvc] ?? "不明";
      const content = r[cCnt] ?? "";
      const points = parseFloat(r[cPt]) || 0;
      const total = parseFloat(r[cTot]) || 0;
      return { _idx:i, date, category, service, content, points, total, ui_category: categorizeLsp(category, service) };
    }).filter(x => x.date && /^\d{4}/.test(x.date));
    return;
  }

  // Miles
  if (sheetName.includes("マイル") || findHeader(["有効マイル"]) !== -1) {
    const idx = findHeader(["有効マイル"]);
    if (idx < 0) return;
    const header = rows[idx];

    // 互換のため固定列も見る
    const body = rows.slice(idx + 1).filter(r => r && r[0]);
    appData.miles = body.map((r, i) => {
      const date = parseDate(r[0]);
      const content = r[1] ?? "";
      const gain = parseInt(r[7]) || 0;
      const total = parseInt(r[8]) || 0;
      const fop = parseInt(r[9]) || 0;
      const flight_count = parseInt(r[10]) || 0;
      return { _idx:i, date, content, gain, total, fop, flight_count, ui_category: categorizeMile(content) };
    }).filter(x => x.date && /^\d{4}/.test(x.date));
    return;
  }

  // Plans
  if (sheetName.includes("計画") || findHeader(["出発地"]) !== -1) {
    const idx = findHeader(["出発地"]);
    if (idx < 0) return;
    const header = rows[idx];
    const col = (name) => header.indexOf(name);

    const cDate = col("日付");
    const cFrom = col("出発地");
    const cTo   = col("到着地");
    const cRes  = col("結果");

    const body = rows.slice(idx + 1).filter(r => r && r[cDate]);
    appData.plans = body.map((r) => ({
      date: parseDate(r[cDate]),
      from: r[cFrom] ?? "",
      to: r[cTo] ?? "",
      status: r[cRes] ?? "予定"
    })).filter(x => x.date && /^\d{4}/.test(x.date));
  }
}

function updateStats() {
  const now = new Date();
  const year = String(now.getFullYear());
  const today = now.toISOString().split("T")[0];

  // miles stats
  if (appData.miles.length) {
    const latest = [...appData.miles].sort((a,b) => b.date.localeCompare(a.date) || b._idx - a._idx)[0];
    appData.stats.miles = latest.total || 0;

    const y = appData.miles.filter(m => String(m.date || "").startsWith(year));
    appData.stats.fop = y.reduce((s, m) => s + (parseInt(m.fop)||0), 0);
    appData.stats.yearlyFlights = y.reduce((s, m) => s + (parseInt(m.flight_count)||0), 0);
  } else {
    appData.stats.miles = 0;
    appData.stats.fop = 0;
    appData.stats.yearlyFlights = 0;
  }

  // lsp stats
  if (appData.lsp.length) {
    const latest = [...appData.lsp].sort((a,b) => b.date.localeCompare(a.date) || b._idx - a._idx)[0];
    appData.stats.lsp = latest.total || 0;
  } else {
    appData.stats.lsp = 0;
  }

  // planned flights
  appData.stats.plannedFlights = appData.plans.filter(p => p.status !== "済" && p.date >= today).length;

  safeSetText("stat-miles", appData.stats.miles.toLocaleString());
  safeSetText("stat-lsp", appData.stats.lsp.toLocaleString());
  safeSetText("stat-fop", appData.stats.fop.toLocaleString());
  safeSetText("stat-yearly-flights", `${appData.stats.yearlyFlights} (+${appData.stats.plannedFlights})`);
}

function renderPieChart(canvasId, groups) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  if (charts[canvasId]) charts[canvasId].destroy();

  const labels = Object.keys(groups).sort((a,b) => (groups[b]||0) - (groups[a]||0));
  const data = labels.map(l => groups[l]);

  charts[canvasId] = new Chart(ctx, {
    type: "doughnut",
    data: { labels, datasets: [{ data }] },
    options: { responsive:true, maintainAspectRatio:false }
  });
}

function updateDashboard() {
  // miles pie: gain>0 のみ
  const mileGroups = appData.miles.reduce((g, d) => {
    const k = d.ui_category || "その他";
    const v = (d.gain > 0 ? d.gain : 0);
    g[k] = (g[k] || 0) + v;
    return g;
  }, {});
  const lspGroups = appData.lsp.reduce((g, d) => {
    const k = d.ui_category || "その他";
    g[k] = (g[k] || 0) + (d.points || 0);
    return g;
  }, {});
  renderPieChart("milePieChart", mileGroups);
  renderPieChart("lspPieChart", lspGroups);

  // debug
  const dbg = {
    miles_rows: appData.miles.length,
    lsp_rows: appData.lsp.length,
    plans_rows: appData.plans.length,
    stats: appData.stats,
    source_url: EXCEL_URL
  };
  document.getElementById("debugInfo").innerText = JSON.stringify(dbg, null, 2);
}

function updateDetail() {
  const title = document.getElementById("detailTitle");
  const tbody = document.getElementById("table-body");
  const sel = document.getElementById("categorySelector");

  let data = [];
  if (currentTab === "miles") {
    title.innerText = "マイル明細";
    data = appData.miles.map(d => ({ date:d.date, content:d.content, value:d.gain, cat:d.ui_category }));
  } else if (currentTab === "lsp") {
    title.innerText = "LSP明細";
    data = appData.lsp.map(d => ({ date:d.date, content:d.content, value:d.points, cat:d.ui_category }));
  } else {
    title.innerText = "フライト計画";
    data = appData.plans.map(d => ({ date:d.date, content:`${d.from}→${d.to}`, value:"", cat:d.status || "予定" }));
  }

  // category selector
  const cats = ["(すべて)"].concat([...new Set(data.map(x => x.cat).filter(Boolean))]);
  sel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join("");
  sel.onchange = () => renderTable();

  function renderTable() {
    const chosen = sel.value;
    const filtered = chosen === "(すべて)" ? data : data.filter(x => x.cat === chosen);
    tbody.innerHTML = filtered.map(d => `
      <tr>
        <td class="p-3 whitespace-nowrap">${d.date || ""}</td>
        <td class="p-3 font-bold">${escapeHtml(d.content || "")}</td>
        <td class="p-3 text-right font-black">${(d.value === "" ? "" : (Number(d.value)||0).toLocaleString())}</td>
      </tr>
    `).join("");
  }

  renderTable();
}

function updateUI() {
  updateStats();
  if (currentTab === "dashboard") updateDashboard();
  else updateDetail();

  const ts = new Date().toLocaleString();
  document.getElementById("lastSync").innerText = `最終反映: ${ts}`;
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

// ---- Load from GitHub Raw URL ----
async function loadFromUrl() {
  showLoading("GitHubからExcel取得中...", "（初回は数秒かかります）");
  try {
    // Cache bust: 反映遅延対策（GitHub Pages / Rawのキャッシュ対策）
    const cacheBusted = EXCEL_URL + (EXCEL_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

    const res = await fetch(cacheBusted, { cache: "no-store" });
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`Fetch failed: ${res.status}\n${txt.slice(0,200)}`);
    }

    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array", cellDates:true });

    resetDataKeepStats();
    wb.SheetNames.forEach(name => {
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
      processRows(name, rows);
    });

    hideLoading();
    updateUI();
  } catch (e) {
    hideLoading();
    console.error(e);
    alert("URLからの読み込みに失敗しました。\n\n考えられる原因:\n・URLが違う\n・GitHubの一時的なアクセス制限\n・ページをHTTPS以外で開いている\n\n詳細はコンソールを確認してください。");
  }
}

// ---- Local file loader ----
function loadFromLocalFile(file) {
  if (!file) return;
  showLoading("ローカルExcelを解析中...", file.name);
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const wb = XLSX.read(ev.target.result, { type: "array", cellDates:true });
      resetDataKeepStats();
      wb.SheetNames.forEach(name => {
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
        processRows(name, rows);
      });
      hideLoading();
      updateUI();
    } catch (e) {
      hideLoading();
      console.error(e);
      alert("ローカルExcelの解析に失敗しました。");
    }
  };
  reader.readAsArrayBuffer(file);
}

// ---- Navigation ----
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll(".nav-item").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
  document.getElementById("tab-dashboard").classList.toggle("active", tab === "dashboard");
  document.getElementById("tab-detail").classList.toggle("active", tab !== "dashboard");
  updateUI();
}

// ---- init ----
window.addEventListener("DOMContentLoaded", () => {
  // nav binding
  document.querySelectorAll(".nav-item").forEach(btn => {
    btn.addEventListener("click", () => switchTab(btn.dataset.tab));
  });

  // sync button
  document.getElementById("btnSync").addEventListener("click", loadFromUrl);

  // file input
  document.getElementById("fileInput").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    loadFromLocalFile(f);
  });

  // 初回：自動でURL同期
  loadFromUrl();
});
</script>
</body>
</html>
